# Регуляторный отчёт по счетам

Учебный проект демонстрирует **полный цикл** построения витрины и отчёта для регуляторного контроля остатков по банковским счетам.

## 📂 Структура репозитория

```
.
├── generate_json.py           # Генератор JSON‑файлов
├── etl_load_accounts.py       # ETL‑загрузка в PostgreSQL
├── Скрипт создания таблиц.sql  # DDL: staging, reporting, представление accounts_view
└── README.md                  # Вы здесь
```

## 🗄️ Хранилище данных (PostgreSQL 15+)

| Схема | Объект | Назначение |
|-------|--------|------------|
| **staging** | `accounts_raw` | Приёмник «как есть» для одной суточной выгрузки |
| **reporting** | `accounts` | Актуальная версия счёта (dedup + SCD‑1) |
| **reporting** | `accounts_view` *(VIEW)* | Отбор счётов с балансом >`500 000` для отчётности |

DDL находится в [`Скрипт создания таблиц.sql`](./Скрипт%20создания%20таблиц.sql).

## ⚙️ Генерация данных

```bash
# создаст ~260 рабочих JSON‑файлов за 2024 год
python generate_json.py
```

Каждый файл содержит 50 записей с допустимым 10 % дублированием.  
Поле `opened_at` варьируется в диапазоне ±5 лет от текущей даты файла.

## 🔄 Загрузка (ETL)

```bash
# 1 — применяем DDL
psql -f "Скрипт создания таблиц.sql"

# 2 — загружаем все JSON‑ы
python etl_load_accounts.py
```

Этапы:
1. **Staging.** `INSERT` исходных строк в `staging.accounts_raw`.
2. **Upsert.** `INSERT … ON CONFLICT` в `reporting.accounts` (оставляем последнюю версию счёта).
3. **Витрина.** Представление `accounts_view` публикует только счета с балансом >`500 000`.

Проверка выборки на 50 записях:

```sql
SELECT *
FROM reporting.accounts_view
LIMIT 50;
```

## 📊 Отчёт в Metabase

В Metabase создан **вопрос «Accounts > 500 k by Date»** на базе представления `accounts_view`:

* Тип: _simple table_  
* Фильтр: поле `load_date` (диапазон)  
* Сортировка — по `balance` (убыв.)

Локальный запуск Metabase (порт `3000`):

```bash
docker run -d --name metabase -p 3000:3000 metabase/metabase
```

После первого запуска подключите PostgreSQL как источник данных и выберите вышеуказанный вопрос для дашборда.
